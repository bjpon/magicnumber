<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Sales Aggregator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f0f2f5; color: #1a1a1a; padding: 24px; min-height: 100vh;
        }
        .container { max-width: 1340px; margin: 0 auto; }
        h1 { font-size: 22px; font-weight: 700; }
        .subtitle { color: #6b7280; font-size: 13px; margin-top: 4px; }
        .header { margin-bottom: 20px; }

        .card {
            background: white; border-radius: 10px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px;
        }

        /* Upload */
        .drop-zone {
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 44px 24px;
            text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .drop-zone:hover, .drop-zone.active { border-color: #3b82f6; background: #eff6ff; }
        .drop-zone .icon { font-size: 32px; margin-bottom: 8px; }
        .drop-zone .label { font-size: 15px; color: #374151; font-weight: 500; }
        .drop-zone .hint { font-size: 12px; color: #9ca3af; margin-top: 6px; }
        .drop-zone input[type="file"] { display: none; }

        .options-row { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; align-items: flex-end; }
        .option-group { display: flex; flex-direction: column; gap: 4px; }
        .option-group label {
            font-size: 11px; font-weight: 600; color: #6b7280;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .option-group input, .option-group select {
            padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;
            font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .option-group input:focus, .option-group select:focus { border-color: #3b82f6; }

        .file-info {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 16px; background: #f0fdf4; border: 1px solid #bbf7d0;
            border-radius: 8px; margin-top: 16px; font-size: 13px;
        }
        .file-info .check { color: #16a34a; font-size: 18px; font-weight: 700; }
        .file-info .name { font-weight: 600; color: #15803d; }
        .file-info .meta { color: #6b7280; margin-left: auto; }

        /* Results */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px; }
        .results-header h2 { font-size: 17px; font-weight: 700; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: all 0.15s ease;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }

        /* Table */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        thead th {
            padding: 9px 14px; text-align: left; font-weight: 700; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px; color: #374151;
            border-bottom: 2px solid #1a1a1a; background: #fafafa;
        }
        tbody td { padding: 6px 14px; border-bottom: 1px solid #eaeaea; color: #374151; }
        .text-right { text-align: right; }
        .col-gap { width: 20px; background: transparent; }
        thead th.col-gap { border-bottom-color: transparent; }

        .segment-last td { border-bottom: 2px solid #1a1a1a; }
        .segment-total-cell { font-weight: 700; color: #1a1a1a; }
        .grand-total td {
            font-weight: 800; font-size: 14px;
            border-top: 3px double #1a1a1a; border-bottom: none; padding-top: 10px;
        }
        .location-cell { font-weight: 600; color: #1a1a1a; vertical-align: top; }

        .hidden { display: none; }

        .toast {
            position: fixed; bottom: 24px; right: 24px; background: #1a1a1a; color: white;
            padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
        }
        .toast.show { opacity: 1; }

        @media (max-width: 768px) {
            body { padding: 12px; }
            .options-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Product Sales Aggregator</h1>
            <p class="subtitle">Upload a sales CSV to aggregate products by strength &amp; flavor with segment breakdowns</p>
        </div>

        <div class="card">
            <div class="drop-zone" id="dropZone">
                <div class="icon">&#128196;</div>
                <div class="label">Drop your CSV file here or click to browse</div>
                <div class="hint">Accepts .csv files in the standard productsSold format</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>

            <div class="options-row">
                <div class="option-group">
                    <label for="locationName">Location / Retailer</label>
                    <input type="text" id="locationName" placeholder="e.g., Dispensary Name" style="width:220px;">
                </div>
                <div class="option-group">
                    <label for="yearLabel">Column Label</label>
                    <input type="text" id="yearLabel" value="2025" style="width:80px;">
                </div>
                <div class="option-group">
                    <label for="dollarCol">Dollar Source</label>
                    <select id="dollarCol" style="width:160px;">
                        <option value="Total" selected>Total (after discounts)</option>
                        <option value="Before Discounts">Before Discounts</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="unitCol">Unit Source</label>
                    <select id="unitCol" style="width:160px;">
                        <option value="Sold Quantity" selected>Sold Quantity</option>
                        <option value="Sold Bulk Quantity">Sold Bulk Quantity</option>
                    </select>
                </div>
            </div>

            <div id="fileInfo" class="file-info hidden">
                <span class="check">&#10003;</span>
                <span class="name" id="fileName"></span>
                <span class="meta" id="fileMeta"></span>
            </div>
        </div>

        <div class="card hidden" id="resultsSection">
            <div class="results-header">
                <h2 id="resultsTitle">Aggregated Results</h2>
                <div class="actions">
                    <button class="btn btn-primary" id="downloadCSV">&#11015; Download CSV</button>
                    <button class="btn btn-secondary" id="copyTable">&#128203; Copy for Sheets</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="resultsTable"></table>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    (function() {
        // ── Helpers ──
        const $ = id => document.getElementById(id);
        const fmtDollars = v => '$' + Math.round(v).toLocaleString('en-US');
        const fmtUnits   = v => Math.round(v).toLocaleString('en-US');
        const fmtPct     = v => Math.round(v * 100) + '%';

        function showToast(msg) {
            const t = $('toast'); t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2200);
        }

        // ── Segment ordering ──
        // Beverages first (descending dose), then drops (descending dose), then anything else
        const SEGMENT_ORDER = {
            '100mg': 10, '50mg': 20, '25mg': 30, '25mg:25mg': 35, '10mg': 40,
            '1000mg': 50, '250mg': 60, '100mg:100mg': 70
        };
        function segmentSortKey(seg) { return SEGMENT_ORDER[seg] ?? 99; }

        // ── Parse one product name ──
        function parseProduct(name) {
            if (!name) return null;

            // Bundles have few pipe segments (product name contains "Bundle" and commas)
            const parts = name.split('|').map(s => s.trim());
            if (parts.length < 5) return null;
            if (name.toLowerCase().includes('bundle')) return null;

            const isTradeSample = /trade\s*sample/i.test(name);

            const dosagePack = parts[2];               // "100mg 12pk" or "25mg:25mg"
            const dosage = dosagePack.split(/\s+/)[0];  // "100mg", "25mg:25mg"
            const flavor = parts[3];                    // "Fruit Punch"
            const strainType = parts[4] || '';          // "Indica Dom", "Sativa", etc.

            return { dosage, flavor, strainType, isTradeSample };
        }

        // ── Aggregation key ──
        // For Mega Drops (1000mg) and Magic Drops (250mg), include strain type
        function aggKey(p) {
            if (p.dosage === '1000mg' || p.dosage === '250mg') {
                return p.dosage + ' ' + p.flavor + ' | ' + p.strainType;
            }
            return p.dosage + ' ' + p.flavor;
        }

        // ── Main processing ──
        function processData(rows) {
            const dollarCol = $('dollarCol').value;
            const unitCol   = $('unitCol').value;

            const agg = {}; // key → { product, segment, dollars, units }

            for (const row of rows) {
                const parsed = parseProduct(row['Product Name']);
                if (!parsed || parsed.isTradeSample) continue;

                const key = aggKey(parsed);
                const dollars = parseFloat(row[dollarCol]) || 0;
                const units   = parseFloat(row[unitCol])   || 0;

                if (!agg[key]) {
                    agg[key] = { product: key, segment: parsed.dosage, dollars: 0, units: 0 };
                }
                agg[key].dollars += dollars;
                agg[key].units   += units;
            }

            // Group by segment
            const segments = {};
            for (const item of Object.values(agg)) {
                (segments[item.segment] ??= []).push(item);
            }

            // Sort products within each segment by dollars desc
            for (const items of Object.values(segments)) {
                items.sort((a, b) => b.dollars - a.dollars);
            }

            // Ordered segment keys
            const orderedSegs = Object.keys(segments).sort((a, b) => segmentSortKey(a) - segmentSortKey(b));

            // Segment totals
            const segTotals = {};
            for (const seg of orderedSegs) {
                segTotals[seg] = {
                    dollars: segments[seg].reduce((s, i) => s + i.dollars, 0),
                    units:   segments[seg].reduce((s, i) => s + i.units, 0)
                };
            }

            // Grand totals
            const grand = {
                dollars: Object.values(segTotals).reduce((s, t) => s + t.dollars, 0),
                units:   Object.values(segTotals).reduce((s, t) => s + t.units, 0)
            };

            // Percentages
            for (const t of Object.values(segTotals)) {
                t.dollarPct = grand.dollars > 0 ? t.dollars / grand.dollars : 0;
                t.unitPct   = grand.units   > 0 ? t.units   / grand.units   : 0;
            }

            return { segments, orderedSegs, segTotals, grand };
        }

        // ── Render table ──
        function renderTable(result) {
            const { segments, orderedSegs, segTotals, grand } = result;
            const location = $('locationName').value.trim();
            const yearLabel = $('yearLabel').value.trim() || '2025';

            let html = `<thead><tr>
                <th style="min-width:140px;"></th>
                <th style="min-width:280px;">Product</th>
                <th class="text-right">${yearLabel}</th>
                <th class="text-right">Segment Total</th>
                <th class="text-right">Seg %</th>
                <th class="col-gap"></th>
                <th class="text-right">Units</th>
                <th class="text-right">Segment Total</th>
                <th class="text-right">Seg %</th>
            </tr></thead><tbody>`;

            let isFirstRow = true;
            let totalProductRows = 0;
            for (const seg of orderedSegs) totalProductRows += segments[seg].length;

            for (const seg of orderedSegs) {
                const items = segments[seg];
                const st = segTotals[seg];

                items.forEach((item, idx) => {
                    const isLast = idx === items.length - 1;
                    const cls = isLast ? ' class="segment-last"' : '';

                    // Location cell: only on the very first data row, rowspan covers the rest
                    let locCell = '';
                    if (isFirstRow) {
                        locCell = `<td class="location-cell" rowspan="${totalProductRows}">${location || ''}</td>`;
                        isFirstRow = false;
                    }

                    const segTotalDollar = isLast ? `<td class="text-right segment-total-cell">${fmtDollars(st.dollars)}</td>` : '<td></td>';
                    const segPctDollar   = isLast ? `<td class="text-right segment-total-cell">${fmtPct(st.dollarPct)}</td>` : '<td></td>';
                    const segTotalUnit   = isLast ? `<td class="text-right segment-total-cell">${fmtUnits(st.units)}</td>` : '<td></td>';
                    const segPctUnit     = isLast ? `<td class="text-right segment-total-cell">${fmtPct(st.unitPct)}</td>` : '<td></td>';

                    html += `<tr${cls}>
                        ${locCell}
                        <td>${item.product}</td>
                        <td class="text-right">${fmtDollars(item.dollars)}</td>
                        ${segTotalDollar}${segPctDollar}
                        <td class="col-gap"></td>
                        <td class="text-right">${fmtUnits(item.units)}</td>
                        ${segTotalUnit}${segPctUnit}
                    </tr>`;
                });
            }

            // Grand total row
            html += `<tr class="grand-total">
                <td></td>
                <td>Grand</td>
                <td></td>
                <td class="text-right">${fmtDollars(grand.dollars)}</td>
                <td></td>
                <td class="col-gap"></td>
                <td></td>
                <td class="text-right">${fmtUnits(grand.units)}</td>
                <td></td>
            </tr>`;

            html += '</tbody>';
            $('resultsTable').innerHTML = html;
        }

        // ── Generate CSV string ──
        function generateCSV(result) {
            const { segments, orderedSegs, segTotals, grand } = result;
            const location = $('locationName').value.trim();
            const yearLabel = $('yearLabel').value.trim() || '2025';
            const rows = [];

            // Header
            rows.push(['', 'Product', yearLabel, 'Segment Total', 'Seg %', '', 'Units', 'Segment Total', 'Seg %']);

            let isFirst = true;
            for (const seg of orderedSegs) {
                const items = segments[seg];
                const st = segTotals[seg];

                items.forEach((item, idx) => {
                    const isLast = idx === items.length - 1;
                    const loc = isFirst ? location : '';
                    if (isFirst) isFirst = false;

                    rows.push([
                        loc,
                        item.product,
                        Math.round(item.dollars),
                        isLast ? Math.round(st.dollars) : '',
                        isLast ? fmtPct(st.dollarPct) : '',
                        '',
                        Math.round(item.units),
                        isLast ? Math.round(st.units) : '',
                        isLast ? fmtPct(st.unitPct) : ''
                    ]);
                });
            }

            // Grand total
            rows.push(['', 'Grand', '', Math.round(grand.dollars), '', '', '', Math.round(grand.units), '']);

            // Convert to CSV
            return rows.map(r => r.map(cell => {
                const s = String(cell);
                return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s;
            }).join(',')).join('\n');
        }

        // ── Generate TSV for clipboard ──
        function generateTSV(result) {
            const { segments, orderedSegs, segTotals, grand } = result;
            const location = $('locationName').value.trim();
            const yearLabel = $('yearLabel').value.trim() || '2025';
            const rows = [];

            rows.push(['', 'Product', yearLabel, 'Segment Total', 'Seg %', '', 'Units', 'Segment Total', 'Seg %']);

            let isFirst = true;
            for (const seg of orderedSegs) {
                const items = segments[seg];
                const st = segTotals[seg];

                items.forEach((item, idx) => {
                    const isLast = idx === items.length - 1;
                    const loc = isFirst ? location : '';
                    if (isFirst) isFirst = false;

                    rows.push([
                        loc,
                        item.product,
                        fmtDollars(item.dollars),
                        isLast ? fmtDollars(st.dollars) : '',
                        isLast ? fmtPct(st.dollarPct) : '',
                        '',
                        fmtUnits(item.units),
                        isLast ? fmtUnits(st.units) : '',
                        isLast ? fmtPct(st.unitPct) : ''
                    ]);
                });
            }

            rows.push(['', 'Grand', '', fmtDollars(grand.dollars), '', '', '', fmtUnits(grand.units), '']);

            return rows.map(r => r.join('\t')).join('\n');
        }

        // ── State ──
        let currentResult = null;

        // ── File handling ──
        function handleFile(file) {
            if (!file || !file.name.endsWith('.csv')) {
                showToast('Please upload a .csv file');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                transformHeader: h => h.trim(),
                complete: function(results) {
                    if (results.errors.length > 0) {
                        console.warn('Parse warnings:', results.errors);
                    }

                    const data = results.data;
                    $('fileName').textContent = file.name;
                    $('fileMeta').textContent = data.length + ' rows parsed';
                    $('fileInfo').classList.remove('hidden');

                    currentResult = processData(data);
                    renderTable(currentResult);

                    $('resultsSection').classList.remove('hidden');

                    const totalProducts = Object.values(currentResult.segments).reduce((s, items) => s + items.length, 0);
                    $('resultsTitle').textContent = `Aggregated Results — ${totalProducts} products across ${currentResult.orderedSegs.length} segments`;
                }
            });
        }

        // ── Event listeners ──
        const dropZone = $('dropZone');
        const fileInput = $('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault(); dropZone.classList.remove('active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

        // Re-process when options change
        ['dollarCol', 'unitCol', 'locationName', 'yearLabel'].forEach(id => {
            $(id).addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
            $(id).addEventListener('input', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
        });

        // Download CSV
        $('downloadCSV').addEventListener('click', () => {
            if (!currentResult) return;
            const csv = generateCSV(currentResult);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const loc = $('locationName').value.trim();
            a.href = url;
            a.download = (loc ? loc.replace(/[^a-zA-Z0-9]/g, '_') + '_' : '') + 'aggregated_sales.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV downloaded!');
        });

        // Copy to clipboard (TSV for spreadsheet paste)
        $('copyTable').addEventListener('click', () => {
            if (!currentResult) return;
            const tsv = generateTSV(currentResult);
            navigator.clipboard.writeText(tsv).then(() => {
                showToast('Copied! Paste into your spreadsheet.');
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = tsv; document.body.appendChild(ta);
                ta.select(); document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Copied! Paste into your spreadsheet.');
            });
        });
    })();
    </script>
</body>
</html>
